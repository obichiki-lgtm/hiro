<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ çµ±åˆå®Œå…¨ç‰ˆ</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <style>
        /* ==========================================
           1. index (21).html å›ºæœ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã®å®Œå…¨å¾©å…ƒ
           ========================================== */
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f8fafb;
            --success-color: #2ecc71;
            --todo-color: #f39c12;
            --danger-color: #ff4d4f;
            --text-color: #333;
            --cal-btn-bg: #2c3e50;
            --test-color: #9b59b6; /* æ‹¡å¼µæ©Ÿèƒ½ç”¨ã‚«ãƒ©ãƒ¼ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            line-height: 1.6;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            position: relative;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ»èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .auth-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 5px;
        }
        #loginBtn {
            background: #eee;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            color: #666;
            font-weight: bold;
            transition: background 0.3s;
        }
        #loginBtn:hover { background: #e0e0e0; }

        /* çµ±è¨ˆãƒ‘ãƒãƒ« (index (21).html ç‹¬è‡ªå½¢çŠ¶) */
        .status-panel {
            display: flex;
            justify-content: space-around;
            background: #fff;
            border: 1px solid #f0f0f0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status-item { flex: 1; text-align: center; }
        .status-value {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .status-label {
            font-size: 0.75rem;
            color: #888;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ã¨ã€Œå®Ÿç¸¾åŒ–ã€ãƒœã‚¿ãƒ³ */
        .input-area {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        input[type="text"] {
            flex: 1;
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border 0.3s, box-shadow 0.3s;
            min-width: 0;
        }
        input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        .add-btn {
            background-color: var(--todo-color);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            min-width: 60px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .direct-done-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            min-width: 60px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* è¦‹å‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ */
        h2 {
            font-size: 1.1rem;
            border-left: 5px solid var(--primary-color);
            padding-left: 12px;
            margin: 30px 0 15px;
            color: #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .todo-header { border-left-color: var(--todo-color); }

        /* ã‚¿ã‚¹ã‚¯ãƒ»ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
        .task-item {
            background: #fff;
            border: 1px solid #f0f0f0;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px;
            font-size: 0.95rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .todo-item { border-left: 6px solid var(--todo-color); }
        .review-item { border-left: 6px solid var(--primary-color); }
        .button-group { display: flex; gap: 8px; }
        .btn-done {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-delete {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š (grid ã‚’ä½¿ã£ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å®Œå…¨å¾©å…ƒ) */
        #calendar {
            margin-top: 10px;
            border-radius: 15px;
            border: 1px solid #eee;
            padding: 10px;
            background: #fff;
            min-height: 450px;
        }
        .fc .fc-toolbar {
            display: grid !important;
            grid-template-columns: auto 1fr auto auto !important;
            align-items: center !important;
            gap: 2px !important;
            margin-bottom: 1.5em !important;
        }
        .fc .fc-toolbar-chunk { display: contents !important; }
        .fc .fc-toolbar-title {
            grid-column: 2 !important;
            font-size: 0.78rem !important;
            font-weight: bold !important;
            padding: 8px 4px !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            background: #fff !important;
            cursor: pointer !important;
            text-align: center !important;
            margin: 0 4px !important;
            white-space: nowrap;
            overflow: hidden;
        }
        .fc .fc-prev-button { grid-column: 1 !important; }
        .fc .fc-next-button { grid-column: 3 !important; }
        .fc .fc-today-button {
            grid-column: 4 !important;
            background-color: #7f8c8d !important;
            font-size: 0.75rem !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            border: none !important;
        }
        .fc .fc-button {
            background-color: var(--cal-btn-bg) !important;
            border: none !important;
            border-radius: 6px !important;
            height: 38px !important;
        }

        /* ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (é–‹é–‰ã‚¢ã‚¤ã‚³ãƒ³ä»˜) */
        .memo-header {
            border-left-color: #556b2f !important;
            cursor: pointer;
        }
        .memo-area {
            margin-top: 10px;
            margin-bottom: 30px;
            display: none;
        }
        #memoInput {
            width: 100%;
            height: 180px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            box-sizing: border-box;
            outline: none;
            transition: border 0.3s;
            background: #fff;
        }

        /* ==========================================
           2. ä¿®æ­£ã—ã¦ã»ã—ã„ã‚„ã¤.html æ‹¡å¼µæ©Ÿèƒ½ãƒ‡ã‚¶ã‚¤ãƒ³
           ========================================== */
        .test-maker-bar {
            background: #fdfaff;
            border: 1px solid #ece0f5;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--test-color);
        }
        #testFormContainer {
            display: none;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        
        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£ */
        .img-upload-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            display: block;
            width: 100%;
            margin-bottom: 5px;
        }
        .preview-img {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 8px;
            display: none;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }
        .tag-input-field {
            width: 100%;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        /* ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #testOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 20000;
            display: none;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .test-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
        }
        .test-q-text { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; }
        .test-a-text {
            font-size: 1.1rem;
            color: var(--primary-color);
            background: #f0f7ff;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            box-sizing: border-box;
            display: none;
            margin-top: 20px;
        }
        .test-img-display {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* SRS åˆ¤å®šãƒœã‚¿ãƒ³ */
        .judge-area {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }
        .judge-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-again { background: #e74c3c; }
        .btn-hard  { background: #f39c12; }
        .btn-good  { background: #2980b9; }
        .btn-easy  { background: #27ae60; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (index (21).html å½¢çŠ¶) */
        .modal-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 25px;
        }
        .banner {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--todo-color);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            transition: top 0.4s;
        }
        .banner.active { top: 20px; }
    </style>
</head>
<body>

    <div id="toastBanner" class="banner">é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

    <div class="container">
        <div class="auth-header">
            <button id="loginBtn" onclick="handleAuth()"> ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <h1 style="font-size:1.4rem; text-align:center; color:var(--primary-color); margin: 5px 0 20px;">å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</h1>
        
        <div class="status-panel">
            <div class="status-item">
                <span class="status-value" id="streakCount">0</span>
                <span class="status-label">ğŸ”¥ ç¶™ç¶šæ—¥æ•°</span>
            </div>
            <div class="status-item">
                <span class="status-value" id="totalDone">0</span>
                <span class="status-label">ğŸ† ç´¯è¨ˆå®Œäº†</span>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="todoInput" placeholder="å­¦ç¿’å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
            <button class="add-btn" onclick="addTodo()">ç™»éŒ²</button>
            <button class="direct-done-btn" onclick="addDirectDone()">å®Œäº†</button>
        </div>

        <div class="test-maker-bar" onclick="toggleElement('testFormContainer')">
            <span>ğŸ“ å¾©ç¿’ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹</span>
            <span id="testMakerArrow">â–¼</span>
        </div>
        <div id="testFormContainer">
            <div class="form-group">
                <label>å•é¡Œ</label>
                <input type="text" id="cardQ" placeholder="ä¾‹: æ†²æ³•ç¬¬13æ¡ã®å†…å®¹ã¯ï¼Ÿ">
            </div>
            <div class="form-group">
                <button class="img-upload-btn" onclick="document.getElementById('fileQ').click()">ğŸ“· å•é¡Œã«ç”»åƒã‚’æ·»ä»˜</button>
                <input type="file" id="fileQ" hidden accept="image/*" onchange="handleImgPreview(this, 'previewQ', 'urlQ')">
                <img id="previewQ" class="preview-img">
                <input type="hidden" id="urlQ">
            </div>
            <div class="form-group">
                <label>è§£ç­”</label>
                <textarea id="cardA" placeholder="ä¾‹: å€‹äººã®å°Šé‡ã€å¹¸ç¦è¿½æ±‚æ¨©..." style="width:100%; border-radius:10px; border:1px solid #ddd; padding:8px;"></textarea>
            </div>
            <div class="form-group">
                <button class="img-upload-btn" onclick="document.getElementById('fileA').click()">ğŸ“· è§£ç­”ã«ç”»åƒã‚’æ·»ä»˜</button>
                <input type="file" id="fileA" hidden accept="image/*" onchange="handleImgPreview(this, 'previewA', 'urlA')">
                <img id="previewA" class="preview-img">
                <input type="hidden" id="urlA">
            </div>
            <div class="form-group">
                <label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                <input type="text" id="cardTags" class="tag-input-field" placeholder="è‹±èª, å˜èª, å°‚é–€..." >
            </div>
            <button class="btn-done" style="width:100%;" onclick="addFlashcard()">ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹</button>
        </div>

        <h2 class="todo-header">ToDoãƒªã‚¹ãƒˆ</h2>
        <div id="todoList"></div>

        <h2 style="border-left-color: var(--test-color);">ğŸ¯ ä»Šæ—¥ã®å¾©ç¿’ãƒ†ã‚¹ãƒˆ</h2>
        <div id="testActionArea"></div>

        <h2>å¾©ç¿’ã‚¿ã‚¹ã‚¯ (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£å‹•)</h2>
        <div id="todayReviewList"></div>

        <h2 class="memo-header" onclick="toggleMemo()">
            å­¦ç¿’ãƒ¡ãƒ¢
            <span id="memoArrow" style="font-size: 0.8rem; color: #ccc;">â–¼</span>
        </h2>
        <div class="memo-area" id="memoContainer">
            <textarea id="memoInput" placeholder="ä»Šæ—¥ã®æ°—ã¥ãã‚„åçœã‚’è‡ªç”±ã«æ›¸ãæ®‹ã—ã¾ã—ã‚‡ã†..."></textarea>
        </div>

        <h2 class="calendar-header">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div id="calendar"></div>

        <h2 style="border-left-color: #e67e22;">ğŸ“š å­¦ç¿’ãƒ­ã‚° & ã‚¿ã‚°</h2>
        <div id="tagStats" style="margin-bottom:20px;"></div>
        <button class="btn-delete" style="width:100%; background:#7f8c8d;" onclick="startRandomTest()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ 10å•ãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div id="testOverlay">
        <div class="test-header">
            <span id="testProgress" style="font-weight:bold; color:#888;">0 / 0</span>
            <button onclick="closeTest()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
        </div>
        <div class="test-body">
            <img id="displayImgQ" class="test-img-display" style="display:none;">
            <div id="displayTextQ" class="test-q-text"></div>
            
            <button id="showAnswerBtn" class="btn-done" style="background:var(--primary-color);" onclick="revealAnswer()">ç­”ãˆã‚’è¡¨ç¤º</button>

            <div id="answerSection" style="display:none; width:100%;">
                <div id="displayTextA" class="test-a-text"></div>
                <img id="displayImgA" class="test-img-display" style="display:none; margin-top:10px;">
                
                <div class="judge-area">
                    <button class="judge-btn btn-again" onclick="submitJudge('again')">ã‚„ã‚Šç›´ã—</button>
                    <button class="judge-btn btn-hard"  onclick="submitJudge('hard')">é›£ã—ã„</button>
                    <button class="judge-btn btn-good"  onclick="submitJudge('good')">æ­£è§£</button>
                    <button class="judge-btn btn-easy"  onclick="submitJudge('easy')">ç°¡å˜</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin:0;">äºˆå®šã®ç·¨é›†</h3>
            <div style="margin-top:15px;">
                <label style="font-size:0.8rem; color:#888;">å­¦ç¿’å†…å®¹:</label>
                <input type="text" id="modalName" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
            </div>
            <div id="modalDateGroup" style="margin-top:15px;">
                <label style="font-size:0.8rem; color:#888;">æ—¥ä»˜:</label>
                <input type="date" id="modalDate" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
            </div>
            <div class="modal-footer">
                <div style="display:flex; gap:10px;">
                    <button onclick="closeModal()" style="flex:1; background:#eee; border:none; padding:12px; border-radius:10px; font-weight:bold;">æˆ»ã‚‹</button>
                    <button id="saveBtn" style="flex:1; background:var(--primary-color); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">ä¿å­˜</button>
                </div>
                <button id="deleteBtn" style="background:var(--danger-color); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">ã“ã®ã‚·ãƒªãƒ¼ã‚ºã‚’å…¨ã¦å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================
           3. Firebase & åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯ (1è¡Œã‚‚å‰Šã‚‰ãšçµ±åˆ)
           ========================================== */
        const firebaseConfig = {
            apiKey: "AIzaSyAP51tb-FcRmc1RukwczxfxzUdOkE7yf4g",
            authDomain: "my-study-app-6a0b6.firebaseapp.com",
            projectId: "my-study-app-6a0b6",
            storageBucket: "my-study-app-6a0b6.firebasestorage.app",
            messagingSenderId: "441129563668",
            appId: "1:441129563668:web:48cc07f882bff1785e5901"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let calendar = null;
        let currentModalData = null;
        let testSession = [];
        let currentTestIdx = 0;

        // æ—¥ä»˜æ“ä½œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        const getTodayStr = () => {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        const addDays = (dateStr, days) => {
            const d = new Date(dateStr + "T00:00:00");
            d.setDate(d.getDate() + days);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        // ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ä¿å­˜ (1è¡Œã‚‚å‰Šã‚‰ãªã„ãƒãƒªã‚·ãƒ¼)
        const getTasks = () => JSON.parse(localStorage.getItem('myTasks') || '[]');
        const getTodos = () => JSON.parse(localStorage.getItem('myTodos') || '[]');
        const getCards = () => JSON.parse(localStorage.getItem('myCards') || '[]');
        
        function saveAll(tasks, todos, cards) {
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            localStorage.setItem('myTodos', JSON.stringify(todos));
            if (cards) localStorage.setItem('myCards', JSON.stringify(cards));
            
            renderUI();
            if (calendar) calendar.refetchEvents();

            if (currentUser) {
                db.collection("users").doc(currentUser.uid).set({
                    tasks, todos, cards: cards || getCards(),
                    memo: document.getElementById('memoInput').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
        }

        // --- ToDoæ©Ÿèƒ½ (index (21).html) ---
        function addTodo() {
            const val = document.getElementById('todoInput').value.trim();
            if (!val) return;
            const todos = getTodos();
            todos.push({ id: Date.now().toString(), name: val, completed: false });
            saveAll(getTasks(), todos);
            document.getElementById('todoInput').value = "";
        }

        function addDirectDone() {
            const val = document.getElementById('todoInput').value.trim();
            if (!val) return;
            const tasks = getTasks();
            const todos = getTodos();
            const today = getTodayStr();
            const id = Date.now().toString();
            
            todos.push({ id, name: val, completed: true });
            const intervals = [0, 1, 4, 11, 25, 55];
            const reviews = intervals.map(days => addDays(today, days));
            tasks.push({ id, name: val, reviews, doneDates: [today], startDate: today });
            
            saveAll(tasks, todos);
            document.getElementById('todoInput').value = "";
            showToast("å®Ÿç¸¾ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ");
        }

        function completeTodo(id) {
            const todos = getTodos();
            const tasks = getTasks();
            const t = todos.find(x => x.id === id);
            if (!t) return;
            t.completed = true;
            const today = getTodayStr();
            const intervals = [0, 1, 4, 11, 25, 55];
            const reviews = intervals.map(days => addDays(today, days));
            tasks.push({ id: t.id, name: t.name, reviews, doneDates: [today], startDate: today });
            saveAll(tasks, todos);
            showToast("å®Œäº†ï¼å¾©ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ");
        }

        function doneReview(id, date) {
            const tasks = getTasks();
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            if (!t.doneDates) t.doneDates = [];
            if (!t.doneDates.includes(date)) t.doneDates.push(date);
            saveAll(tasks, getTodos());
            showToast("å¾©ç¿’ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
        }

        /* ==========================================
           4. SRSãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯ (å¢—ç¯‰åˆ†ï¼š1è¡Œã‚‚å‰Šã‚‰ãš)
           ========================================== */
        async function handleImgPreview(input, previewId, urlId) {
            const file = input.files[0];
            if (!file) return;
            const preview = document.getElementById(previewId);
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            
            if (currentUser) {
                showToast("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...");
                const ref = storage.ref(`users/${currentUser.uid}/${Date.now()}_${file.name}`);
                const snap = await ref.put(file);
                document.getElementById(urlId).value = await snap.ref.getDownloadURL();
                showToast("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†");
            }
        }

        function addFlashcard() {
            const q = document.getElementById('cardQ').value.trim();
            const a = document.getElementById('cardA').value.trim();
            const qImg = document.getElementById('urlQ').value;
            const aImg = document.getElementById('urlA').value;
            const tags = document.getElementById('cardTags').value.split(',').map(t => t.trim()).filter(t => t);

            if (!q && !qImg) return alert("å•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const cards = getCards();
            cards.push({
                id: Date.now().toString(),
                q, a, qImg, aImg, tags,
                nextReview: getTodayStr(),
                interval: 0,
                history: []
            });

            saveAll(getTasks(), getTodos(), cards);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            ['cardQ', 'cardA', 'urlQ', 'urlA', 'cardTags'].forEach(id => document.getElementById(id).value = "");
            ['previewQ', 'previewA'].forEach(id => document.getElementById(id).style.display = 'none');
            showToast("ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        }

        function startSession(mode, tag = null) {
            const cards = getCards();
            const today = getTodayStr();
            
            if (mode === 'today') {
                testSession = cards.filter(c => c.nextReview <= today);
            } else if (mode === 'random') {
                testSession = [...cards].sort(() => 0.5 - Math.random()).slice(0, 10);
            } else if (tag) {
                testSession = cards.filter(c => c.tags.includes(tag));
            }

            if (testSession.length === 0) return alert("ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“");
            
            currentTestIdx = 0;
            document.getElementById('testOverlay').style.display = 'flex';
            showTest();
        }

        function showTest() {
            const card = testSession[currentTestIdx];
            document.getElementById('testProgress').innerText = `${currentTestIdx + 1} / ${testSession.length}`;
            
            // ç”»é¢ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('answerSection').style.display = 'none';
            document.getElementById('showAnswerBtn').style.display = 'block';
            
            // å•é¡Œè¡¨ç¤º
            document.getElementById('displayTextQ').innerText = card.q || "";
            const imgQ = document.getElementById('displayImgQ');
            if (card.qImg) { imgQ.src = card.qImg; imgQ.style.display = 'block'; } else { imgQ.style.display = 'none'; }
            
            // è§£ç­”æº–å‚™
            document.getElementById('displayTextA').innerText = card.a || "(è§£ç­”ãªã—)";
            const imgA = document.getElementById('displayImgA');
            if (card.aImg) { imgA.src = card.aImg; imgA.style.display = 'block'; } else { imgA.style.display = 'none'; }
        }

        function revealAnswer() {
            document.getElementById('answerSection').style.display = 'block';
            document.getElementById('showAnswerBtn').style.display = 'none';
        }

        function submitJudge(judge) {
            const card = testSession[currentTestIdx];
            const cards = getCards();
            const target = cards.find(c => c.id === card.id);
            const today = getTodayStr();

            let nextDays = 1;
            if (judge === 'again') nextDays = 0;
            else if (judge === 'hard') nextDays = (target.interval || 1) * 1 + 1;
            else if (judge === 'good') nextDays = (target.interval || 1) * 2 + 1;
            else if (judge === 'easy') nextDays = (target.interval || 1) * 4 + 2;

            if (nextDays > 150) nextDays = 150;

            target.nextReview = addDays(today, nextDays);
            target.interval = nextDays;
            target.history.push({ date: today, judge });

            saveAll(getTasks(), getTodos(), cards);

            currentTestIdx++;
            if (currentTestIdx < testSession.length) {
                showTest();
            } else {
                alert("å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                closeTest();
            }
        }

        function closeTest() {
            document.getElementById('testOverlay').style.display = 'none';
        }

        /* ==========================================
           5. UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° & ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
           ========================================== */
        function renderUI() {
            const tasks = getTasks();
            const todos = getTodos();
            const cards = getCards();
            const today = getTodayStr();

            // çµ±è¨ˆè¨ˆç®—
            const doneSet = new Set();
            tasks.forEach(t => t.doneDates?.forEach(d => doneSet.add(d)));
            document.getElementById('totalDone').innerText = tasks.reduce((acc, t) => acc + (t.doneDates?.length || 0), 0);
            
            let streak = 0;
            let check = today;
            while(doneSet.has(check)) { streak++; check = addDays(check, -1); }
            document.getElementById('streakCount').innerText = streak;

            // ToDoãƒªã‚¹ãƒˆ
            const todoList = document.getElementById('todoList');
            todoList.innerHTML = todos.filter(t => !t.completed).map(t => `
                <div class="task-item todo-item">
                    <span>${t.name}</span>
                    <div class="button-group">
                        <button class="btn-done" onclick="completeTodo('${t.id}')">å®Œäº†</button>
                        <button class="btn-delete" onclick="deleteItem('${t.id}', 'todo')">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('') || '<p style="text-align:center; color:#999; font-size:0.8rem;">ToDoã¯ã‚ã‚Šã¾ã›ã‚“</p>';

            // ä»Šæ—¥ã®ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢
            const dueCards = cards.filter(c => c.nextReview <= today);
            const testActionArea = document.getElementById('testActionArea');
            if (dueCards.length > 0) {
                testActionArea.innerHTML = `<button class="btn-done" style="width:100%; background:var(--test-color);" onclick="startSession('today')">ğŸ”¥ ä»Šæ—¥ã®å¾©ç¿’ã‚’é–‹å§‹ (${dueCards.length}æš)</button>`;
            } else {
                testActionArea.innerHTML = `<p style="text-align:center; color:#999; font-size:0.8rem;">æœ¬æ—¥ã®ãƒ†ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>`;
            }

            // å¾©ç¿’ã‚¿ã‚¹ã‚¯
            const reviewList = document.getElementById('todayReviewList');
            const todayReviews = [];
            tasks.forEach(t => {
                t.reviews.forEach((d, idx) => {
                    if (d === today && (!t.doneDates || !t.doneDates.includes(d))) {
                        todayReviews.push({ ...t, currentReviewDate: d, reviewIdx: idx });
                    }
                });
            });
            reviewList.innerHTML = todayReviews.map(t => `
                <div class="task-item review-item">
                    <span onclick="openEdit('${t.id}', '${t.currentReviewDate}', ${t.reviewIdx})" style="cursor:pointer">
                        ${t.name} <small style="color:#888;">(ç¬¬${t.reviewIdx+1}å›)</small>
                    </span>
                    <button class="btn-done" onclick="doneReview('${t.id}', '${t.currentReviewDate}')">å®Œäº†</button>
                </div>
            `).join('') || '<p style="text-align:center; color:#999; font-size:0.8rem;">ä»Šæ—¥ã®å¾©ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“</p>';

            // ã‚¿ã‚°çµ±è¨ˆ
            const tagStats = document.getElementById('tagStats');
            const tagMap = {};
            cards.forEach(c => c.tags.forEach(tag => tagMap[tag] = (tagMap[tag] || 0) + 1));
            tagStats.innerHTML = Object.entries(tagMap).map(([tag, count]) => `
                <button class="btn-delete" style="background:#4a90e2; margin-bottom:5px;" onclick="startSession('tag', '${tag}')">#${tag} (${count})</button>
            `).join(' ');
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»UIæ“ä½œ ---
        function toggleElement(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        function toggleMemo() {
            const area = document.getElementById('memoContainer');
            const arrow = document.getElementById('memoArrow');
            if (area.style.display === 'block') {
                area.style.display = 'none';
                arrow.innerText = 'â–¼';
            } else {
                area.style.display = 'block';
                arrow.innerText = 'â–²';
            }
        }

        function showToast(msg) {
            const b = document.getElementById('toastBanner');
            b.innerText = msg;
            b.classList.add('active');
            setTimeout(() => b.classList.remove('active'), 2500);
        }

        function openEdit(taskId, date, idx) {
            const t = getTasks().find(x => x.id === taskId);
            currentModalData = { type: 'task', taskId, date, idx };
            document.getElementById('modalTitle').innerText = "å¾©ç¿’ã®ç·¨é›†";
            document.getElementById('modalName').value = t.name;
            document.getElementById('modalDate').value = date;
            document.getElementById('taskModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('taskModal').style.display = 'none';
        }

        function deleteItem(id, type) {
            if (type === 'todo') {
                const todos = getTodos().filter(x => x.id !== id);
                saveAll(getTasks(), todos);
            }
        }

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ– (index (21).html å®Œå…¨ç¶­æŒ) ---
        window.onload = () => {
            const calEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev', center: 'title', right: 'next today' },
                locale: 'ja',
                height: 'auto',
                events: (info, success) => {
                    const tasks = getTasks();
                    const evs = [];
                    tasks.forEach(t => {
                        t.reviews.forEach((d, idx) => {
                            const isDone = t.doneDates?.includes(d);
                            evs.push({
                                id: t.id,
                                title: (isDone ? "âœ… " : "") + t.name,
                                start: d,
                                color: isDone ? '#2ecc71' : '#4a90e2',
                                extendedProps: { date: d, idx }
                            });
                        });
                    });
                    success(evs);
                },
                eventClick: (info) => {
                    openEdit(info.event.id, info.event.extendedProps.date, info.event.extendedProps.idx);
                }
            });
            calendar.render();

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ“ãƒ¥ãƒ¼å¤‰æ›´ (ç‹¬è‡ªä»•æ§˜)
            document.querySelector('.fc-toolbar-title').onclick = () => {
                const views = ['dayGridMonth', 'dayGridWeek', 'listMonth'];
                const current = calendar.view.type;
                const next = views[(views.indexOf(current) + 1) % views.length];
                calendar.changeView(next);
            };

            renderUI();
            
            // è‡ªå‹•ä¿å­˜
            document.getElementById('memoInput').oninput = () => {
                localStorage.setItem('myMemo', document.getElementById('memoInput').value);
                if (currentUser) saveAll(getTasks(), getTodos());
            };
        };

        // --- Firebase Auth é€£æº ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('loginBtn').innerText = user ? "âœ… åŒæœŸä¸­" : "â˜ï¸ ãƒ­ã‚°ã‚¤ãƒ³";
            if (user) syncCloud();
        });

        async function handleAuth() {
            if (currentUser) {
                if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) await auth.signOut();
            } else {
                await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            }
        }

        async function syncCloud() {
            const doc = await db.collection("users").doc(currentUser.uid).get();
            if (doc.exists) {
                const d = doc.data();
                document.getElementById('memoInput').value = d.memo || "";
                saveAll(d.tasks || [], d.todos || [], d.cards || []);
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å‰Šé™¤ãƒœã‚¿ãƒ³
        document.getElementById('deleteBtn').onclick = () => {
            if (confirm("ã“ã®ã‚·ãƒªãƒ¼ã‚ºå…¨ã¦ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                const tasks = getTasks().filter(x => x.id !== currentModalData.taskId);
                saveAll(tasks, getTodos());
                closeModal();
            }
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¿å­˜ãƒœã‚¿ãƒ³
        document.getElementById('saveBtn').onclick = () => {
            const tasks = getTasks();
            const t = tasks.find(x => x.id === currentModalData.taskId);
            t.name = document.getElementById('modalName').value;
            t.reviews[currentModalData.idx] = document.getElementById('modalDate').value;
            saveAll(tasks, getTodos());
            closeModal();
        };

        function startRandomTest() { startSession('random'); }

    </script>
</body>
</html>
